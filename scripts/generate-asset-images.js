/* eslint-disable no-undef */
/**
 * Script to automatically generate asset-images.ts from all images in the assets folder.
 * Run this script whenever new images are added to the assets folder.
 *
 * Usage: bun run scripts/generate-asset-images.js
 */

const fs = require('fs');
const path = require('path');

const SCRIPT_DIR = path.dirname(require.resolve('./generate-asset-images.js'));
const ASSETS_DIR = path.join(SCRIPT_DIR, '..', 'assets');
const PUBLIC_DIR = path.join(SCRIPT_DIR, '..', 'public');
const OUTPUT_FILE = path.join(SCRIPT_DIR, '..', 'src', 'lib', 'asset-images.ts');

// Supported image extensions
const IMAGE_EXTENSIONS = ['.png', '.jpg', '.jpeg', '.gif', '.webp'];

function getImageFilesFromDir(dir, relativePath) {
  if (!fs.existsSync(dir)) return [];
  const files = fs.readdirSync(dir);
  return files.filter(file => {
    const ext = path.extname(file).toLowerCase();
    return IMAGE_EXTENSIONS.includes(ext);
  }).map(file => ({ file, relativePath }));
}

function getImageFiles() {
  // Get images from both assets/ and public/ folders
  const assetsImages = getImageFilesFromDir(ASSETS_DIR, '../../assets');
  const publicImages = getImageFilesFromDir(PUBLIC_DIR, '../../public');
  return [...assetsImages, ...publicImages];
}

function categorizeImage(filename) {
  if (filename.startsWith('image-')) return 'image';
  if (filename.startsWith('background-')) return 'background';
  if (filename.startsWith('icon-')) return 'icon';
  if (filename.startsWith('logo-')) return 'logo';
  return 'other';
}

function generateAssetId(filename, index, category) {
  // Remove extension
  const nameWithoutExt = filename.replace(/\.[^/.]+$/, '');
  // Use the original filename as ID for better traceability
  return nameWithoutExt;
}

function generateAssetImagesFile() {
  const imageFiles = getImageFiles();

  console.log(`Found ${imageFiles.length} images in assets and public folders`);

  // Group images by category
  const categorized = {
    image: [],
    background: [],
    icon: [],
    logo: [],
    other: []
  };

  imageFiles.forEach(({ file, relativePath }) => {
    const category = categorizeImage(file);
    categorized[category].push({ file, relativePath });
  });

  // Generate the TypeScript file content
  let content = `// Auto-generated file - DO NOT EDIT MANUALLY
// Generated by scripts/generate-asset-images.js
// Run "bun run scripts/generate-asset-images.js" to regenerate

// Asset images that are bundled with the app
// These images are available to all users (synced via the app bundle)

export const ASSET_IMAGES: Record<string, number> = {
`;

  // Add all images
  const allAssetIds = [];

  Object.entries(categorized).forEach(([category, files]) => {
    if (files.length === 0) return;

    content += `  // ${category.charAt(0).toUpperCase() + category.slice(1)} images\n`;

    files.forEach(({ file, relativePath }, index) => {
      const assetId = generateAssetId(file, index, category);
      allAssetIds.push(assetId);
      content += `  '${assetId}': require('${relativePath}/${file}'),\n`;
    });

    content += '\n';
  });

  content += `};

// All asset IDs
export const ALL_ASSET_IDS = Object.keys(ASSET_IMAGES);

// Category arrays for filtering
export const IMAGE_ASSET_IDS = ALL_ASSET_IDS.filter(id => id.startsWith('image-'));
export const BACKGROUND_ASSET_IDS = ALL_ASSET_IDS.filter(id => id.startsWith('background-'));
export const ICON_ASSET_IDS = ALL_ASSET_IDS.filter(id => id.startsWith('icon-'));
export const LOGO_ASSET_IDS = ALL_ASSET_IDS.filter(id => id.startsWith('logo-'));

// Legacy exports for backward compatibility
export const PACK_ASSET_IDS = IMAGE_ASSET_IDS.slice(0, 10);
export const PRODUCER_ASSET_IDS = IMAGE_ASSET_IDS.slice(0, 4);
export const FIELD_ASSET_IDS = IMAGE_ASSET_IDS.slice(0, 6);
export const ILLUSTRATION_ASSET_IDS = IMAGE_ASSET_IDS.slice(0, 3);

// Get the image source for a given image string
// Handles both asset: prefixed strings and regular URLs
export function getImageSource(image: string | undefined | null): number | { uri: string } | undefined {
  if (!image) {
    return undefined;
  }
  if (image.startsWith('asset:')) {
    const assetId = image.replace('asset:', '');
    const assetSource = ASSET_IMAGES[assetId];
    if (assetSource) {
      return assetSource;
    }
  }
  return { uri: image };
}

// Check if an image is an asset image
export function isAssetImage(image: string): boolean {
  return image.startsWith('asset:');
}
`;

  fs.writeFileSync(OUTPUT_FILE, content);
  console.log(`Generated ${OUTPUT_FILE} with ${allAssetIds.length} images`);
  console.log('\nCategories:');
  Object.entries(categorized).forEach(([category, files]) => {
    if (files.length > 0) {
      console.log(`  - ${category}: ${files.length} images`);
    }
  });
}

generateAssetImagesFile();
